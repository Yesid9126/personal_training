<a
  href="{% if src %}{{ src }}{% else %}http://atrilco.com/wp-content/uploads/2017/11/ef3-placeholder-image.jpg{% endif %}"
  id="source-link-{{ field_name }}"
  target="_blank"
>
  {% if image %}
  <img
    src="{% if src %}{{ src }}{% else %}http://atrilco.com/wp-content/uploads/2017/11/ef3-placeholder-image.jpg{% endif %}"
    id="source-thumbnail-{{ field_name }}"
    width="450"
    height="300"
  />
  {% elif video %}
  <video
    src="{% if src %}{{ src }}{% else %}http://atrilco.com/wp-content/uploads/2017/11/ef3-placeholder-image.jpg{% endif %}"
    id="source-thumbnail-{{ field_name }}"
    tabindex="-1"
    style="background-color: transparent"
    preload="metadata"
    width="450"
    height="300"
    preload="metadata"
    controls
  />
  {% elif audio %}
  <audio
    src="{% if src %}{{ src }}{% else %}http://atrilco.com/wp-content/uploads/2017/11/ef3-placeholder-image.jpg{% endif %}"
    id="source-thumbnail-{{ field_name }}"
    width="450"
    height="300"
  />
  {% endif %}
</a>
<script>
  // Vainilla javascript ðŸš€ (Babel defaults, not ie 11, not ie_mob 11)

  // This function adds an event listener over the input image field (`my_field_image`).
  // If the user edits that field, the preview image will be updated.
  let load_page = 1; // se deja aqui para evitar que la pagina intente cargarse varias
  function changeInlineThumbnail() {
    const modelNmae = "{{ model_name }}";
    let fieldName = "{{ field_name }}";
    let form_idx = document.getElementById(
      `id_${modelNmae}_set-TOTAL_FORMS`
    )?.value;

    if (form_idx) {
      console.log("****************");
      console.log(form_idx);
      for (let i = 0; i < form_idx; i++) {
        console.log("------------------");
        console.log(i);
        final_fieldName = `_set-${i}-${modelNmae}`;
        document.getElementById("source-thumbnail-{{ field_name }}").id +=
          final_fieldName;
        document.getElementById("source-link-{{ field_name }}").id +=
          final_fieldName;
        changeThumbnail("{{ field_name }}" + final_fieldName);
      }
    } else {
      changeThumbnail("{{ field_name }}");
    }
  }

  function changeThumbnail(fieldName) {
    document
      .getElementById(`id_${fieldName}`)
      .addEventListener("change", function (e) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById(`source-thumbnail-${fieldName}`).src =
            e.target.result;
          document.getElementById(`source-link-${fieldName}`).href =
            e.target.result;
        };
        reader.readAsDataURL(this.files[0]);
      });
  }

  // This function executes a callback when the document is ready.
  // https://stackoverflow.com/questions/9899372
  //
  // Is this required?
  // No, but, in most cases, the image preview is rendered above the input field,
  // as we do in the `admin.py` module.
  // In that case, need to wait for the document to be ready before adding the
  // event listener defined in `changeThumbnail`.
  function docReady(fn) {
    if (
      document.readyState === "complete" ||
      document.readyState === "interactive"
    ) {
      setTimeout(fn, 1);
    } else {
      document.addEventListener("DOMContentLoaded", fn);
    }
  }
  docReady(changeInlineThumbnail);
</script>
